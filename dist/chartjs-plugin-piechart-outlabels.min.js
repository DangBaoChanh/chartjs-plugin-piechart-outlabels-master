/*!
 * @energiency/chartjs-plugin-piechart-outlabels v1.3.4
 * http://www.chartjs.org
 * (c) 2017-2025 @energiency/chartjs-plugin-piechart-outlabels contributors
 * Released under the MIT license
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e(require("chart.js"),require("chart.js/helpers")):"function"==typeof define&&define.amd?define(["chart.js","chart.js/helpers"],e):(t="undefined"!=typeof globalThis?globalThis:t||self).ChartPieChartOutlabels=e(t.Chart,t.Chart.helpers)}(this,(function(t,e){"use strict";var i={PLUGIN_KEY:"$outlabels",backgroundColor:function(t){return t.dataset.backgroundColor},borderColor:function(t){return t.dataset.backgroundColor},lineColor:function(t){return t.dataset.backgroundColor},borderRadius:0,borderWidth:0,lineWidth:2,color:"white",display:!0,font:{family:void 0,size:void 0,style:void 0,weight:null,maxSize:null,minSize:null,resizable:!0},lineHeight:1.2,padding:{top:2,right:2,bottom:2,left:2},textAlign:"center",stretch:12,horizontalStrechPad:12,text:"%l %p",maxZoomOutPercentage:50,percentPrecision:1,valuePrecision:3};const s=new WeakMap;function r(t){let e=s.get(t);return e||(e={sizeChanged:!1,fitting:!1},s.set(t,e)),e}var n=function(t,e){var i=(t.startAngle+t.endAngle)/2,s=Math.cos(i),r=Math.sin(i),n=t.outerRadius,h=n+e;return{x:t.x+s*h,y:t.y+r*h,d:h,arc:t,anchor:{x:t.x+s*n,y:t.y+r*n},copy:{x:t.x+s*h,y:t.y+r*h}}};function h(i,s){var r=e.valueOrDefault(i.size,t.Chart.defaults.defaultFontSize);i.resizable&&(r=function(t,e,i){var s=t/100*2.5;return e&&s<e?e:i&&s>i?i:s}(s,i.minSize,i.maxSize));var n={family:e.valueOrDefault(i.family,t.Chart.defaults.defaultFontFamily),lineHeight:e.toLineHeight(i.lineHeight,r),size:r,style:e.valueOrDefault(i.style,t.Chart.defaults.defaultFontStyle),weight:e.valueOrDefault(i.weight,null),string:""};return n.string=function(t){return!t||e.isNullOrUndef(t.size)||e.isNullOrUndef(t.family)?null:(t.style?t.style+" ":"")+(t.weight?t.weight+" ":"")+t.size+"px "+t.family}(n),n}var o=i.PLUGIN_KEY;var l=function(t,s,r,l,a){if(!e.resolve([l.display,!0],a,s))throw new Error("Label display property is set to false.");var c=a.dataset.data[s],d=a.labels[s],u=e.resolve([l.text,i.text],a,s);((u=(u=u.replace(/%l/gi,d)).replace(/%v\.?\d*/gi,x(c))).match(/%p\.?(\d*)/gi)||[]).map((function(t){var e=t.replace(/%p\./gi,"");return e.length?+e:l.percentPrecision||i.percentPrecision})).forEach((function(t){u=u.replace(/%p\.?(\d*)/i,(100*a.percent).toFixed(t)+"%")}));for(var f=u.match(/[^\r\n]+/g)||[],g=0;g<f.length;++g)f[g]=f[g].trim();function x(t){if(t<1e3)return t.toString();return`${(t/1e3).toFixed(t%1e3==0?0:2)}K`}this.init=function(t,n){this.encodedText=l.text,this.text=t,this.lines=n,this.label=d,this.value=c,this.style={backgroundColor:e.resolve([l.backgroundColor,i.backgroundColor,"black"],a,s),borderColor:e.resolve([l.borderColor,i.borderColor,"black"],a,s),borderRadius:e.resolve([l.borderRadius,0],a,s),borderWidth:e.resolve([l.borderWidth,0],a,s),lineWidth:e.resolve([l.lineWidth,2],a,s),lineColor:e.resolve([l.lineColor,i.lineColor,"black"],a,s),color:e.resolve([l.color,"white"],a,s),font:h(e.resolve([l.font,{resizable:!0}]),r.canvas.style.height.slice(0,-2)),padding:e.toPadding(e.resolve([l.padding,0],a,s)),textAlign:e.resolve([l.textAlign,"left"],a,s)},this.stretch=e.resolve([l.stretch,i.stretch],a,s),this.horizontalStrechPad=e.resolve([l.horizontalStrechPad,i.horizontalStrechPad],a,s),this.size=function(t,e,i){var s,r=[].concat(e),n=r.length,h=t.font,o=0;for(t.font=i.string,s=0;s<n;++s)o=Math.max(t.measureText(r[s]).width,o);return t.font=h,{height:n*i.lineHeight,width:o}}(r,this.lines,this.style.font),this.offsetStep=this.size.width/20,this.offset={x:0,y:0}};const y=x(c);/%v\.?\d*/i.test(u)||(u=u.replace(/%v/gi,y));const b=u.indexOf("-");if(-1!==b){const t=u.slice(0,b+1),e=u.slice(b+1).trim();u=e.length>15?t+" "+e.slice(0,15)+"...":t+" "+e}else u.length>15&&(u=u.slice(0,15)+"...");f=(f=u.match(/[^\r\n]+/g)||[]).map((t=>t.trim())),this.init(u,f),this.computeLabelRect=function(){var t=this.textRect.width+2*this.style.borderWidth+this.style.padding.left+this.style.padding.right,e=this.textRect.height+2*this.style.borderWidth+this.style.padding.top+this.style.padding.bottom;return{x:this.textRect.x-this.style.borderWidth,y:this.textRect.y-this.style.borderWidth,width:t,height:e,isLeft:this.textRect.isLeft,isTop:this.textRect.isTop}},this.computeTextRect=function(){const t=this.center.x-this.center.anchor.x<0,e=this.center.y-this.center.anchor.y<0,i=t?-(this.horizontalStrechPad+this.size.width):this.horizontalStrechPad;return{x:this.center.x-this.style.padding.left+i,y:this.center.y-this.size.height/2,width:this.size.width,height:this.size.height,isLeft:t,isTop:e}},this.drawText=function(t){var e,i,s,r=this.style.textAlign,n=this.style.font.lineHeight,h=this.style.color,o=this.lines.length;if(o&&h)for(e=this.textRect.x,i=this.textRect.y+n/2,"center"===r?e+=this.textRect.width/2:"end"!==r&&"right"!==r||(e+=this.textRect.width),t.font=this.style.font.string,t.fillStyle=h,t.textAlign=r,t.textBaseline="middle",s=0;s<o;++s)t.fillText(this.lines[s],Math.round(e)+this.style.padding.left,Math.round(i),Math.round(this.textRect.width)),i+=n},this.drawLabel=function(t){t.beginPath(),t.roundRect(Math.round(this.labelRect.x),Math.round(this.labelRect.y),Math.round(this.labelRect.width),Math.round(this.labelRect.height),this.style.borderRadius),t.closePath(),this.style.backgroundColor&&(t.fillStyle=this.style.backgroundColor||"transparent",t.fill()),this.style.borderColor&&this.style.borderWidth&&(t.strokeStyle=this.style.borderColor,t.lineWidth=this.style.borderWidth,t.lineJoin="miter",t.stroke())},this.ccw=function(t,e,i){return(i.y-t.y)*(e.x-t.x)>(e.y-t.y)*(i.x-t.x)},this.intersects=function(t,e,i,s){return this.ccw(t,i,s)!==this.ccw(e,i,s)&&this.ccw(t,e,i)!==this.ccw(t,e,s)},this.drawLine=function(t){if(!this.lines.length)return;t.save(),t.strokeStyle=this.style.lineColor,t.lineWidth=this.style.lineWidth,t.lineJoin="miter",t.beginPath(),t.moveTo(this.center.anchor.x,this.center.anchor.y),t.lineTo(this.center.copy.x,this.center.copy.y),t.stroke(),t.beginPath(),t.moveTo(this.center.copy.x,this.center.copy.y);const e=this.textRect.width+this.style.padding.width,i=this.intersects(this.textRect,{x:this.textRect.x+this.textRect.width,y:this.textRect.y+this.textRect.height},this.center.copy,{x:this.textRect.x,y:this.textRect.y+this.textRect.height/2});t.lineTo(this.textRect.x+(i?e:0),this.textRect.y+this.textRect.height/2),t.stroke(),t.restore()},this.draw=function(e){t.getDataVisibility(s)&&!this.hidden&&(this.drawLabel(e),this.drawText(e),this.drawLine(e))},this.update=function(e,i,r){this.center=n(e,this.stretch);let h=!1,l=5;for(;!h&&l>0;){this.textRect=this.computeTextRect(),this.labelRect=this.computeLabelRect();const n=this.labelRect,f=e.outerRadius,g=e.x,x=e.y;if([{x:n.x,y:n.y},{x:n.x+n.width,y:n.y},{x:n.x,y:n.y+n.height},{x:n.x+n.width,y:n.y+n.height}].some((t=>{const e=t.x-g,i=t.y-x;return Math.sqrt(e*e+i*i)<f})))return i[s][o]=null,void(this.hidden=!0);h=!0;for(var a=0;a<r;++a){var c=i[a][o];if(c&&t.getDataVisibility(s)&&(d=this.labelRect,u=c.labelRect,d.x<u.x+u.width&&d.x+d.width>u.x&&d.y<u.y+u.height&&d.y+d.height>u.y)){h=!1;break}}h?l--:(this.offset.x+=this.offsetStep,this.center.x+=this.offsetStep,l--)}var d,u;h?this.hidden=!1:(i[s][o]=null,this.hidden=!0)}};t.defaults.plugins.outlabels=i;var a=i.PLUGIN_KEY;function c(t){for(let e=0,i=t.length;e<i;e++){const i=t[e],s=i[a];s&&s.update(i,t,e)}}function d(t){const e=t._metasets[0].controller,i=e.getMeta(),s=function(t){const e={left:1/0,right:-1/0,top:1/0,bottom:-1/0};for(let i=0,s=t.length;i<s;i++){const s=t[i][a];if(!s||!s.labelRect)continue;const{labelRect:r}=s,{x:n,y:h,width:o,height:l}=r;e.left=Math.min(e.left,n),e.right=Math.max(e.right,n+o),e.top=Math.min(e.top,h),e.bottom=Math.max(e.bottom,h+l)}return{...e,width:e.right-e.left,height:e.bottom-e.top}}(i.data||[]),r=function(t,e){const{width:i,height:s}=e,r=[(e.left-t.left)/i*2,(e.top-t.top)/s*2,(t.right-e.right)/i*2,(t.bottom-e.bottom)/s*2];return 1-Math.max(0,...r)}(s,t.chartArea);return!(!r||1===r)&&(e.outerRadius=e.outerRadius*r,e.innerRadius*=r,e.updateElements(i.data,0,i.data.length,"none"),!0)}return{id:"outlabels",resize:function(t){r(t).sizeChanged=!0},afterUpdate:t=>{const e=t._metasets[0].controller.getMeta().data||[];let i=!1,s=e.length;for(r(t).fitting=!0;!i&&s-- >0;)c(e),i=!d(t);r(t).fitting=!1},afterDatasetUpdate:function(t,e,i){var s,n,h,o,c,d,u=t.config.data.labels,f=t.data.datasets[e.index],g=function(t,e){var i=t.outlabels;return!1===i?null:(!0===i&&(i={}),Object.assign({},{},e,i))}(f,i),x=g&&g.display,y=e.meta.data||[],b=t.ctx;for(b.save(),d=0;d<y.length;++d){if(n=(s=y[d])[a],h=f.data[d]/e.meta.total,o=null,x&&s&&!s.hidden)try{c={chart:t,dataIndex:d,dataset:f,labels:u,datasetIndex:e.index,percent:h},o=new l(t,d,b,g,c)}catch(t){o=null}n&&o&&!r(t).sizeChanged&&n.label===o.label&&n.encodedText===o.encodedText&&(o.offset=n.offset),s[a]=o}b.restore(),r(t).sizeChanged=!1},afterDatasetDraw:function(t,e){var i=e.meta.data||[],s=t.ctx;r(t).fitting||i.forEach(((t,e)=>{const r=t[a];r&&(r.update(t,i,e),r.draw(s))}))},afterDestroy:function(t){!function(t){s.delete(t)}(t)}}}));
